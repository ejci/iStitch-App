var stitch=function(l){if("undefined"===typeof l)throw"No image to process";if(!window.CanvasRenderingContext2D||!document.createElement("canvas").getContext||!window.HTMLCanvasElement)throw"No canvas support";var q,r,s,t,w,h,p=[],p=palette;return{processStitches:function(c){c=c?c:{};c.cols=c.cols?c.cols:25;c.palette=c.palette?p[c.palette]:p[1];q=l.width;r=l.height;s=document.getElementById("canvas");t=canvas.getContext("2d");s.setAttribute("width",q);s.setAttribute("height",r);t=s.getContext("2d");
t.drawImage(l,0,0);var g=w=t.getImageData(0,0,q,r),f=c;c={rows:0,cols:0,data:[]};var j,d;j=f.cols;g=q/j;d=Math.floor(1/g*r);var a=document.createElement("canvas");a.height=l.height*(1/g);a.width=l.width*(1/g);g=a.getContext("2d");g.drawImage(l,0,0,j,d);g=g.getImageData(0,0,j,d);if(f.brightness&&(a=f.brightness,0!=a)){for(var b=g.data,e=0;e<b.length;e+=4)b[e]+=a,b[e+1]+=a,b[e+2]+=a;g.data=b}if(f.grayscale){a=g.data;for(b=0;b<a.length;b+=4)a[b]=a[b+1]=a[b+2]=0.2126*a[b]+0.7152*a[b+1]+0.0722*a[b+2];
g.data=a;f.palette=p[0]}f=(f=f.palette)?f:p[0];a=g.data;for(b=0;b<a.length;b+=4){for(var e={r:a[b],g:a[b+1],b:a[b+2]},k=9999,m=e,n=0;n<f.colors.length;n++){var u=f.colors[n],v=Math.sqrt(Math.pow(u.r-e.r,2)+Math.pow(u.g-e.g,2)+Math.pow(u.b-e.b,2));v<k&&(m=u,k=v)}e=m;a[b]=e.r;a[b+1]=e.g;a[b+2]=e.b;a[b+3]=a[b+3]}g.data=a;f=[];for(a=0;a<d;a++){c.data[a]=[];for(b=0;b<j;b++){k=4*(a*j+b);e={};0!==g.data[k+3]?(e.r=g.data[k+0],e.g=g.data[k+1],e.b=g.data[k+2]):(e.r=255,e.g=255,e.b=255);e.a=255;a:{for(m=k=0;m<
f.length;m++){n=f[m];if(e.r===n.r&&e.g===n.g&&e.b===n.b){e=m;break a}k++}f.push(e);e=k}c.data[a].push({c:e})}}c.cols=j;c.rows=d;c.colors=f;h=c;h.timestamp=(new Date).getTime()},getPattern:function(){return h?(h.type="x",h.version="0.0.1",h):!1},getCanvas:function(c,g){if(h=g?g:h){c=c?c:{};c.width=c.width?c.width:600;c.grid=c.grid?c.grid:!1;c.pixels=c.pixels?c.pixels:!1;var f=Math.floor(c.width/h.cols);c.width=h.cols*f+10;c.height=h.rows*f+10;var j=document.createElement("canvas");j.setAttribute("width",
c.width+10);j.setAttribute("height",c.height+10);j.width=c.width+10;j.height=c.height+10;var d=j.getContext("2d");d.beginPath();d.fillStyle="rgba(255,255,255,255)";d.fillRect(0,0,c.width+10,c.height+10);d.stroke();for(var a=1;a<h.cols;a++)d.beginPath(),0==a%10?(d.strokeStyle="rgba(100,100,100,255)",d.lineWidth=1,d.moveTo(10+a*f,0),d.lineTo(10+a*f,c.height+20)):(d.strokeStyle="rgba(200,200,200,200)",d.lineWidth=1,d.moveTo(10+a*f,10),d.lineTo(10+a*f,c.height)),d.stroke(),d.closePath();for(var b=1;b<
h.rows;b++)d.beginPath(),0==b%10?(d.strokeStyle="rgba(100,100,100,255)",d.lineWidth=1,d.moveTo(0,10+b*f),d.lineTo(c.width+20,10+b*f)):(d.strokeStyle="rgba(200,200,200,200)",d.lineWidth=1,d.moveTo(10,10+b*f),d.lineTo(c.width,10+b*f)),d.stroke(),d.closePath();for(a=0;a<h.cols;a++)for(b=0;b<h.rows;b++){d.beginPath();var e=h.data[b][a],e=h.colors[e.c];765!=e.r+e.g+e.b&&(d.strokeStyle="rgba("+e.r+","+e.g+","+e.b+",255)",d.lineWidth=2,d.lineCap="round",d.moveTo(10+a*f,10+b*f),d.lineTo(10+a*f+f,10+b*f+f),
d.stroke(),d.moveTo(10+a*f+f,10+b*f),d.lineTo(10+a*f,10+b*f+f),d.stroke(),d.closePath())}return j}throw"No stitchies..";}}},palette=[{name:"2-bit Grayscale",colors:[{r:0,g:0,b:0},{r:104,g:104,b:104},{r:184,g:184,b:184},{r:255,g:255,b:255}]},{name:"3-bit RGB",def:!0,colors:[{r:0,g:0,b:0},{r:0,g:39,b:251},{r:0,g:249,b:44},{r:0,g:252,b:255},{r:255,g:48,b:22},{r:255,g:63,b:252},{r:255,g:255,b:51},{r:255,g:255,b:255}]},{name:"4-bit RGBI",colors:[{r:0,g:0,b:0},{r:0,g:18,b:144},{r:0,g:143,b:21},{r:0,g:144,
b:146},{r:155,g:23,b:7},{r:154,g:32,b:145},{r:148,g:145,b:25},{r:184,g:184,b:184},{r:104,g:104,b:104},{r:0,g:39,b:251},{r:0,g:249,b:44},{r:0,g:252,b:255},{r:255,g:48,b:22},{r:255,g:63,b:252},{r:255,g:255,b:51},{r:255,g:255,b:255}]},{name:"3-level RGB",colors:[{r:0,g:0,b:0},{r:0,g:18,b:144},{r:0,g:39,b:251},{r:155,g:23,b:7},{r:149,g:47,b:251},{r:255,g:48,b:22},{r:255,g:52,b:146},{r:255,g:63,b:252},{r:0,g:143,b:21},{r:0,g:144,b:146},{r:0,g:148,b:252},{r:148,g:145,b:25},{r:146,g:146,b:146},{r:142,g:150,
b:252},{r:255,g:150,b:33},{r:255,g:154,b:253},{r:0,g:249,b:44},{r:0,g:250,b:150},{r:0,g:255,b:254},{r:128,g:250,b:46},{r:126,g:251,b:150},{r:120,g:253,b:254},{r:255,g:253,b:51},{r:255,g:253,b:152},{r:255,g:255,b:255}]}];window.stitch=stitch;window.palette=palette;
