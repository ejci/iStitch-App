/*
 *  Library: parallel.js
 *  Author: Adam Savitzky
 *  License: Creative Commons 3.0
 */
(function(e,t){var n=e?require("./worker"):window.Worker,r=e?require("./url"):window.URL,i=e?require("./blob"):window.Blob;var s=function(){var s=function(){var e={files:[],funcs:[]};var n=function(e){var t=new RegExp("^(http|https|file)://[a-zA-Z0-9-.]+.[a-zA-Z]{2,3}(:[a-zA-Z0-9]*)?/?([a-zA-Z0-9-._?,'/\\+&%$#=~])*$");return t.test(e)};var r=function(e){return n(e)?e:[window.location.origin,e].join("/")};var i=function(){var n=t.toArray(arguments);e.funcs=t.filter(n,t.isFunction);e.files=t.chain(n).filter(t.isString).map(r).value()};i.state=e;return i}();var o=function(){var o=function(t){var n=t.toString();return e?'process.on("message", function (m) { process.send({ data : JSON.stringify(('+n+").apply(process, JSON.parse(m))) }); });":"self.onmessage = function (e) { self.postMessage(JSON.stringify(("+n+").apply(self, JSON.parse(e.data)))); };"};var u=function(n){return e?(s.state.files.length?t.map(s.state.files,function(e){return"require("+e+");"}).join(""):"")+n:(s.state.files.length?'importScripts("'+s.state.files.join('","')+'");':"")+n};var a=function(e){return e+(s.state.funcs.length?t.invoke(s.state.funcs,"toString").join(";")+";":"")};var f=t.compose(a,u,o);var l=function(e){var s=f(e),o=new i([s],{type:"text/javascript"}),u=r.createObjectURL(o),a=new n(u);a.onmessage=t.bind(this.onWorkerMsg,a);this.worker=a;this.worker.ref=this};l.prototype.onWorkerMsg=function(t){this.ref.data=JSON.parse(t.data);if(e){this.ref.worker.terminate()}};l.prototype.data=undefined;l.prototype.fetch=function(e){if(this.data==="___terminated"){return}return this.data?e?e(this.data):this.data:setTimeout(t.bind(this.fetch,this,e),0)&&undefined};l.prototype.terminate=function(){this.data="___terminated";this.worker.terminate()};return function(e,t){var n=new l(e);n.worker.postMessage(JSON.stringify([].concat(t)));return n}}();var u=function(){var e=function(e,n,r){this.mapper=e;this.reducer=n;this.chunks=r;this.refs=t.map(r,function(t){return o(e,[].concat(t))})};e.prototype.fetch=function(e){var n=this.fetchRefs(),r=this;if(t.isEqual(n,t.without(n,undefined))){return e?e(t.reduce(n,this.reducer)):t.reduce(n,this.reducer)}setTimeout(function(){r.fetch(e)},100)};e.prototype.fetchRefs=function(e){return t.map(this.refs,function(t){return t.fetch(e||undefined)},this)};e.prototype.terminate=function(e){e!==undefined?this.refs[e].terminate():t.invoke(this.refs,"terminate")};return function(t,n,r,i){var s=new e(t,n,r);s.fetch(i);return s}}();return{mapreduce:u,spawn:o,require:s}}();if(e){this.exports=s}else{this.Parallel=s}}).call(typeof module!=="undefined"&&module.exports?module:window,typeof module!=="undefined"&&module.exports,typeof module!=="undefined"&&module.exports?require("underscore"):_)